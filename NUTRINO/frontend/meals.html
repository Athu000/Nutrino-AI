<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My AI Meal Plan</title>
    <script type="module" src="./script/meal.js"></script>
    <script type="module" src="./script/NutrinoAPI.js"></script>
    <script type="module" src="./script/auth.js"></script>
    <script type="module">
        import { handleMealPlan } from "./script/NutrinoAPI.js";

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("meal-plan").innerHTML = '<p class="loading">‚è≥ Loading your meal plan...</p>';
            handleMealPlan("fetch");
        });
    </script>

    <style>
        /* General Styling */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            width: 100%;
            text-align: center;
        }

        h2 {
            color: #333;
            font-weight: 700;
            margin-bottom: 20px;
        }

        /* Loading Animation */
        .loading {
            font-size: 16px;
            color: #777;
            font-style: italic;
            margin-top: 10px;
        }

        /* Meal Grid */
        .meals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* Meal Card */
        .meal-item {
            background: #ffffff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: left;
            transition: transform 0.2s ease-in-out;
        }

        .meal-item:hover {
            transform: scale(1.02);
        }

        .meal-item h3 {
            color: #007bff;
            margin-bottom: 10px;
            font-size: 20px;
            font-weight: 600;
        }

        .meal-item p {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
        }

        .meal-section {
            margin-top: 10px;
        }

        .meal-section strong {
            color: #444;
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }

        .meal-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .meal-section ul li {
            background: #f1f3f5;
            padding: 8px;
            margin: 4px 0;
            border-radius: 5px;
            font-size: 14px;
            color: #333;
        }

        /* No Data Message */
        .no-data {
            font-size: 16px;
            color: #777;
            font-style: italic;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>üçΩÔ∏è My AI Meal Plan</h2>
        <div id="meal-plan" class="meals-grid"></div>
    </div>

    <script type="module">
        import { handleMealPlan } from "./script/NutrinoAPI.js";

        async function displayMealPlan() {
            const mealPlanContainer = document.getElementById("meal-plan");
            mealPlanContainer.innerHTML = '<p class="loading">‚è≥ Fetching meal plan...</p>';

            try {
                const user = auth.currentUser;
                if (!user) {
                    console.error("‚ùå User not logged in.");
                    mealPlanContainer.innerHTML = '<p class="no-data">‚ö†Ô∏è Please log in to see your meal plan.</p>';
                    return;
                }

                console.log("üîç Fetching meal plan for user:", user.uid);

                const mealPlanQuery = query(
                    collection(db, "meals"),
                    where("userId", "==", user.uid),
                    orderBy("createdAt", "desc"),
                    limit(1)
                );

                const querySnapshot = await getDocs(mealPlanQuery);
                console.log("üìú Firestore Query Result:", querySnapshot.docs.map(doc => doc.data()));

                if (querySnapshot.empty) {
                    console.warn("‚ö†Ô∏è No meal plan found.");
                    mealPlanContainer.innerHTML = '<p class="no-data">‚ö†Ô∏è No meal plan found. Try generating one!</p>';
                    return;
                }

                const latestMealPlan = querySnapshot.docs[0].data().mealPlan;
                console.log("‚úÖ Meal Plan Found:", latestMealPlan);

                mealPlanContainer.innerHTML = formatMealPlan(latestMealPlan);
            } catch (error) {
                console.error("‚ùå Error fetching meal plan:", error);
                mealPlanContainer.innerHTML = '<p class="no-data">‚ùå Failed to load meal plan. Try again later.</p>';
            }
        }

        function formatMealPlan(text) {
            if (!text) return '<p class="no-data">‚ö†Ô∏è No meal plan available.</p>';

            const sections = text.split("\n\n").map(section => {
                const lines = section.split("\n");
                if (lines.length < 2) return "";

                return `
                    <div class="meal-item">
                        <h3>${lines[0]}</h3>
                        <div class="meal-section">
                            <strong>üçΩÔ∏è Ingredients:</strong>
                            <ul>${lines[1].split(",").map(item => `<li>${item.trim()}</li>`).join("")}</ul>
                        </div>
                        <div class="meal-section">
                            <strong>üîÑ Instructions:</strong>
                            <ul>${lines.slice(2).map(step => `<li>${step.trim()}</li>`).join("")}</ul>
                        </div>
                    </div>
                `;
            }).join("");

            return sections || '<p class="no-data">‚ö†Ô∏è No meal plan available.</p>';
        }

        document.addEventListener("DOMContentLoaded", function () {
            displayMealPlan();
        });
    </script>
</body>
</html>
